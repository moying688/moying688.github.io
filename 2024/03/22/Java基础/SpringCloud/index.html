<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SpringCloud学习 | 一只末影酱的小屋</title><meta name="author" content="末影"><meta name="copyright" content="末影"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="首先的话还是感谢黑马提供的快速入门课程。当然，仅仅是快速入门。  视频如下：  https://www.bilibili.com/video/BV1kH4y1S7wz/?share_source=copy_web&amp;vd_source=3362e6914fb759983690e6e0f1072453 在课前资料中给大家提供了黑马商城项目的资料，先导入这个单体项目。不过需要注意的是，你必须做好">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud学习">
<meta property="og:url" content="http://example.com/2024/03/22/Java%E5%9F%BA%E7%A1%80/SpringCloud/index.html">
<meta property="og:site_name" content="一只末影酱的小屋">
<meta property="og:description" content="首先的话还是感谢黑马提供的快速入门课程。当然，仅仅是快速入门。  视频如下：  https://www.bilibili.com/video/BV1kH4y1S7wz/?share_source=copy_web&amp;vd_source=3362e6914fb759983690e6e0f1072453 在课前资料中给大家提供了黑马商城项目的资料，先导入这个单体项目。不过需要注意的是，你必须做好">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.helloimg.com/i/2024/11/19/673c8661d457e.png">
<meta property="article:published_time" content="2024-03-21T16:00:00.000Z">
<meta property="article:modified_time" content="2024-05-09T11:52:29.470Z">
<meta property="article:author" content="末影">
<meta property="article:tag" content="新东西">
<meta property="article:tag" content="web">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.helloimg.com/i/2024/11/19/673c8661d457e.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/03/22/Java%E5%9F%BA%E7%A1%80/SpringCloud/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringCloud学习',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-09 19:52:29'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.css"><link rel="" "stylesheet"="" href="/css/background.css"><link rel="stylesheet" href="/css/mycss.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css">
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="/css/progress_bar.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments-o"></i><span> 分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://www.helloimg.com/i/2024/11/19/673c8661d457e.png')"><nav id="nav"><span id="blog-info"><a href="/" title="一只末影酱的小屋"><span class="site-name">一只末影酱的小屋</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments-o"></i><span> 分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SpringCloud学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-03-21T16:00:00.000Z" title="发表于 2024-03-22 00:00:00">2024-03-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-09T11:52:29.470Z" title="更新于 2024-05-09 19:52:29">2024-05-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">12.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>48分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="SpringCloud学习"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img" style="background-image: url('https://www.helloimg.com/i/2024/11/19/673c8661d457e.png');"></div><article class="post-content" id="article-container"><p>首先的话还是感谢黑马提供的快速入门课程。当然，仅仅是快速入门。</p>
<blockquote>
<p>视频如下：</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1kH4y1S7wz/?share_source=copy_web&amp;vd_source=3362e6914fb759983690e6e0f1072453">https://www.bilibili.com/video/BV1kH4y1S7wz/?share_source=copy_web&amp;vd_source=3362e6914fb759983690e6e0f1072453</a></p>
<p>在课前资料中给大家提供了黑马商城项目的资料，先导入这个单体项目。不过需要注意的是，你必须做好一些准备：</p>
<ul>
<li>Centos7的环境及一个好用的SSH客户端</li>
<li>安装好Docker</li>
<li>会使用Docker</li>
</ul>
<p>如果你没有这样的Linux环境，或者不是Centos7的话，那么这里有一篇参考文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://b11et3un53m.feishu.cn/wiki/FJAnwOhpIihMkLkOKQocdWZ7nUc">Linux环境搭建</a></li>
</ul>
<p>建议按照上面的文档来搭建虚拟机环境，使用其它版本会出现一些环境问题，比较痛苦。</p>
<p>如果已经有Linux环境，但是没有安装Docker的话，那么这里还有一篇参考文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://b11et3un53m.feishu.cn/wiki/Rfocw7ctXij2RBkShcucLZbrn2d">安装Docker</a></li>
</ul>
<h2 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h2><p>微服务架构，首先是服务化，就是将单体架构中的功能模块从单体应用中拆分出来，独立部署为多个服务。同时要满足下面的一些特点：</p>
<ul>
<li><strong>单一职责</strong>：一个微服务负责一部分业务功能，并且其核心数据不依赖于其它模块。</li>
<li><strong>团队自治</strong>：每个微服务都有自己独立的开发、测试、发布、运维人员，团队人员规模不超过10人（2张披萨能喂饱）</li>
<li><strong>服务自治</strong>：每个微服务都独立打包部署，访问自己独立的数据库。并且要做好服务隔离，避免对其它服务产生影响</li>
</ul>
<p>例如，黑马商城项目，我们就可以把商品、用户、购物车、交易等模块拆分，交给不同的团队去开发，并独立部署：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTczOGY5ODE1ZjBjZGMzMTY1M2Q1MzQzNTkwMDFlMTNfbUN4UFJmYmdkb2xvclZsNGFwbEhIbzk1a0tsSW9qYVJfVG9rZW46WjR1YmJRaG01b1hxQ1V4MGhvYWNDazg4blFnXzE3MTQ4MDkxNDI6MTcxNDgxMjc0Ml9WNA" alt="img"></p>
<p>那么，单体架构存在的问题有没有解决呢？</p>
<ul>
<li>团队协作成本高？<ul>
<li>由于服务拆分，每个服务代码量大大减少，参与开发的后台人员在1~3名，协作成本大大降低</li>
</ul>
</li>
<li>系统发布效率低？<ul>
<li>每个服务都是独立部署，当有某个服务有代码变更时，只需要打包部署该服务即可</li>
</ul>
</li>
<li>系统可用性差？<ul>
<li>每个服务独立部署，并且做好服务隔离，使用自己的服务器资源，不会影响到其它服务。</li>
</ul>
</li>
</ul>
<p>综上所述，微服务架构解决了单体架构存在的问题，特别适合大型互联网项目的开发，因此被各大互联网公司普遍采用。大家以前可能听说过分布式架构，分布式就是服务拆分的过程，其实微服务架构正式分布式架构的一种最佳实践的方案。</p>
<h2 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h2><p>其中我们将会学到Nacos，OpenFeign,Gateway,Sentinel的使用</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=ODZmYzJmNGNmNGQ2NjM2OWM0YTQ4ODg1Nzc3ZTQ2M2ZfRjlodjBaMW5zRmxRYTdDSUdITjVDbHNVVU50UFhRZ0ZfVG9rZW46VjZJTGI5aW1Vb2U5Y1p4NmxsNWNtMG15bnpjXzE3MTQ4MDkyMDg6MTcxNDgxMjgwOF9WNA" alt="img"></p>
<p>而且SpringCloud依托于SpringBoot的自动装配能力，大大降低了其项目搭建、组件使用的成本。对于没有自研微服务组件能力的中小型企业，使用SpringCloud全家桶来实现微服务开发可以说是最合适的选择了！</p>
<h3 id="单体项目拆分为微服务"><a href="#单体项目拆分为微服务" class="headerlink" title="单体项目拆分为微服务"></a>单体项目拆分为微服务</h3><p>将每个板块单独拆分出来，变成一个个微服务。比如，购物车、商品、支付、用户这些都能够提取为单独的一个模块。</p>
<h4 id="怎么拆"><a href="#怎么拆" class="headerlink" title="怎么拆"></a>怎么拆</h4><p>之前我们说过，微服务拆分时<strong>粒度要小</strong>，这其实是拆分的目标。具体可以从两个角度来分析：</p>
<ul>
<li><strong>高内聚</strong>：每个微服务的职责要尽量单一，包含的业务相互关联度高、完整度高。</li>
<li><strong>低耦合</strong>：每个微服务的功能要相对独立，尽量减少对其它微服务的依赖，或者依赖接口的稳定性要强。</li>
</ul>
<p><strong>高内聚</strong>首先是<strong>单一职责，</strong>但不能说一个微服务就一个接口，而是要保证微服务内部业务的完整性为前提。目标是当我们要修改某个业务时，最好就只修改当前微服务，这样变更的成本更低。</p>
<p>一旦微服务做到了高内聚，那么服务之间的<strong>耦合度</strong>自然就降低了。</p>
<p>当然，微服务之间不可避免的会有或多或少的业务交互，比如下单时需要<strong>查询商品数据</strong>。这个时候我们不能在订单服务直接查询商品数据库，否则就导致了数据耦合。而应该由<strong>商品服务对应暴露接口</strong>，并且一定要保证微服务对外<strong>接口的稳定性</strong>（即：尽量保证接口外观不变）。虽然出现了服务间调用，但此时无论你如何在商品服务做内部修改，都不会影响到订单微服务，服务间的耦合度就降低了。</p>
<p>明确了拆分目标，接下来就是拆分方式了。我们在做服务拆分时一般有两种方式：</p>
<ul>
<li><strong>纵向</strong>拆分</li>
<li><strong>横向</strong>拆分</li>
</ul>
<p>所谓<strong>纵向拆分</strong>，就是按照项目的功能模块来拆分。例如黑马商城中，就有用户管理功能、订单管理功能、购物车功能、商品管理功能、支付功能等。那么按照功能模块将他们拆分为一个个服务，就属于纵向拆分。这种拆分模式可以尽可能提高服务的内聚性。</p>
<p>而<strong>横向拆分</strong>，是看各个功能模块之间有没有公共的业务部分，如果有将其抽取出来作为通用服务。例如用户登录是需要发送消息通知，记录风控数据，下单时也要发送短信，记录风控数据。因此消息发送、风控数据记录就是通用的业务功能，因此可以将他们分别抽取为公共服务：消息中心服务、风控管理服务。这样可以提高业务的复用性，避免重复开发。同时通用业务一般接口稳定性较强，也不会使服务之间过分耦合。</p>
<p>一般微服务项目有两种不同的工程结构：</p>
<ul>
<li>完全解耦：每一个微服务都创建为一个独立的工程，甚至可以使用不同的开发语言来开发，项目完全解耦。<ul>
<li>优点：服务之间耦合度低</li>
<li>缺点：每个项目都有自己的独立仓库，管理起来比较麻烦</li>
</ul>
</li>
<li>Maven聚合：整个项目为一个Project，然后每个微服务是其中的一个Module<ul>
<li>优点：项目代码集中，管理和运维方便（授课也方便）</li>
<li>缺点：服务之间耦合，编译时间较长</li>
</ul>
</li>
</ul>
<p>我们这里使用纵向拆分的形式，以及Maven聚合。</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=NjZmNjliMjY3ZTQ2NjI3MmUyMWNkODI1OGM3Mzg1ZjBfMkpBSlNhcXNlSkdqalVTVklDZ0dXU0dnZFd6a3BjS0NfVG9rZW46VllxV2JOT1dYb1l6Z3h4eDVZYmNBaG9vbmpjXzE3MTQ4MDk2Mjc6MTcxNDgxMzIyN19WNA" alt="img"></p>
<p><img src="C:\Users\末影\AppData\Roaming\Typora\typora-user-images\image-20240504160115662.png" alt="image-20240504160115662"></p>
<p>拆分的时候，可以优先把controller拆过去，如果合理的话，一般名字就已经对应好了。然后根据引入的类再进行迁移。</p>
<p>拆分环境就不多说了，这里变化很多，最好根据实际情况灵活变通。</p>
<h3 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h3><p>拆分后不可避免的出现很多的问题。由于项目之间完全没有耦合，也就意味着，两个微服务之间无法进行相互调用，显然是不行的，就像购物车不可能不调用商品服务。而且大多数服务也都需要获取用户信息啊。</p>
<p>因此要想解决这个问题，我们就必须改造其中的代码，把原本本地方法调用，改造成跨微服务的远程调用（<strong>RPC</strong>，即<strong>R</strong>emote <strong>P</strong>roduce <strong>C</strong>all）。</p>
<p>因此，现在查询购物车列表的流程变成了这样：</p>
<p><img src="https://img2.imgtp.com/2024/05/04/xpPZmPhQ.png" alt="img"></p>
<p>代码中需要变化的就是这一步：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=NjZiZmI4MjA2NWJhNTlmZjcyNWEzMWUzYjU5NDQzYWNfNDdDVTVSajJ6TnVnbmc0M2ZsU3dvR2JmNmJ0UnNNVmZfVG9rZW46QWFHVmJBc0s3bzY2Ukd4anJKM2N6VWs5bk9oXzE3MTQ4MTAyMzM6MTcxNDgxMzgzM19WNA" alt="img"></p>
<p>类似思路的话，就跟我们前端获取数据，或者使用爬虫的时候很类似。通过使用http请求去调用。</p>
<h4 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h4><blockquote>
<p>Spring给我们提供了RestTemplate的APi，可以方便实现发送Http请求（也可用来搞爬虫）</p>
</blockquote>
<p>先将RestTemplate注册为一个Bean：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.cart.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteCallConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>使用方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">ResponseEntity&lt;List&lt;ItemDTO&gt;&gt; exchange = restTemplate.exchange(</span><br><span class="line">               <span class="string">"http://localhost:8081/items?ids={ids}"</span>, <span class="comment">//请求路径</span></span><br><span class="line">                HttpMethod.GET,  <span class="comment">//请求方法</span></span><br><span class="line">                <span class="literal">null</span>,   <span class="comment">//请求实体</span></span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;List&lt;ItemDTO&gt;&gt;() {},<span class="comment">//返回值类型               </span></span><br><span class="line">               Map.of(<span class="string">"ids"</span> ,CollUtils.join(itemIds, <span class="string">","</span>)) <span class="comment">//传入参数</span></span><br><span class="line">       );</span><br><span class="line"><span class="comment">//解析响应</span></span><br><span class="line">    <span class="keyword">if</span>(!response.getStatusCode().is2xxSuccessful()){</span><br><span class="line">        <span class="comment">// 查询失败，直接结束</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    List&lt;ItemDTO&gt; items = response.getBody();</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>爬虫用起来也还好，其实主要是信息筛选老火</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">TestRestTemplate</span><span class="params">()</span>{</span><br><span class="line">    ResponseEntity&lt;String&gt; exchange = restTemplate.exchange(</span><br><span class="line">            <span class="string">"https://www.bing.com/images/search?q=明日方舟德克萨斯"</span>,</span><br><span class="line">            HttpMethod.GET,</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;String&gt;() {</span><br><span class="line">            }</span><br><span class="line">    );</span><br><span class="line">    <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> exchange.getBody();</span><br><span class="line">    System.out.println(<span class="string">"body = "</span> + body);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>





<h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><p>上述调用我们也发现了问题，就是必须知道调用的具体地址，但是实际开发我们都分成好几个小组了，总不能每次改端口都口口相传，那服务宕机了该怎么办？</p>
<ul>
<li>item-service这么多实例，cart-service如何知道每一个实例的地址？</li>
<li>http请求要写url地址，<code>cart-service</code>服务到底该调用哪个实例呢？</li>
<li>如果在运行过程中，某一个<code>item-service</code>实例宕机，<code>cart-service</code>依然在调用该怎么办？</li>
<li>如果并发太高，<code>item-service</code>临时多部署了N台实例，<code>cart-service</code>如何知道新实例的地址？</li>
</ul>
<p>为了解决上述问题，就必须引入注册中心的概念了，接下来我们就一起来分析下注册中心的原理。</p>
<h4 id="注册中心原理"><a href="#注册中心原理" class="headerlink" title="注册中心原理"></a>注册中心原理</h4><p>其实就有点类似于学校管理一样，只不过这个更快。</p>
<p>在微服务远程调用的过程中，包括两个角色：</p>
<ul>
<li>服务提供者：提供接口供其它微服务访问，比如<code>item-service</code></li>
<li>服务消费者：调用其它微服务提供的接口，比如<code>cart-service</code></li>
</ul>
<p>在大型微服务项目中，服务提供者的数量会非常多，为了管理这些服务就引入了<strong>注册中心</strong>的概念。注册中心、服务提供者、服务消费者三者间关系如下：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=YjQwMzk1NjhhOTE3MmVmMjlhNWQ4MjcwMzQxNDU1NTRfRGxSMnVjU3BWOExZRTZRZTh6d09adG1sdDZtbnRJaGdfVG9rZW46STU4NWJ5bVVNb2FQU0J4bXpkVWNveGY2bmNmXzE3MTQ4MTE4MDI6MTcxNDgxNTQwMl9WNA" alt="img"></p>
<p>流程如下：</p>
<ul>
<li>服务启动时就会注册自己的服务信息（服务名、IP、端口）到注册中心</li>
<li>调用者可以从注册中心订阅想要的服务，获取服务对应的实例列表（1个服务可能多实例部署）</li>
<li>调用者自己对实例列表负载均衡，挑选一个实例</li>
<li>调用者向该实例发起远程调用</li>
</ul>
<p>当服务提供者的实例宕机或者启动新实例时，调用者如何得知呢？</p>
<ul>
<li>服务提供者会定期向注册中心发送请求，报告自己的健康状态（心跳请求）</li>
<li>当注册中心长时间收不到提供者的心跳时，会认为该实例宕机，将其从服务的实例列表中剔除</li>
<li>当服务有新实例启动时，会发送注册服务请求，其信息会被记录在注册中心的服务实例列表</li>
<li>当注册中心服务列表变更时，会主动通知微服务，更新本地服务列表</li>
</ul>
<blockquote>
<p>就跟老师找学生一样,不需要到处找,去教务系统查询你的相关信息然后去教室或者你家堵你就行了.(额,别杠,不然你对)</p>
</blockquote>
<h3 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h3><p>目前开源的注册中心框架有很多，国内比较常见的有：</p>
<ul>
<li>Eureka：Netflix公司出品，目前被集成在SpringCloud当中，一般用于Java应用</li>
<li>Nacos：Alibaba公司出品，目前被集成在SpringCloudAlibaba中，一般用于Java应用</li>
<li>Consul：HashiCorp公司出品，目前集成在SpringCloud中，不限制微服务语言</li>
</ul>
<p>使用Nacos前,需要使用数据库保存一些信息,所以先准备好MySQL数据库表.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">-- --------------------------------------------------------</span><br><span class="line">-- 主机:                           192.168.87.132</span><br><span class="line">-- 服务器版本:                        8.0.27 - MySQL Community Server - GPL</span><br><span class="line">-- 服务器操作系统:                      Linux</span><br><span class="line">-- HeidiSQL 版本:                  12.2.0.6576</span><br><span class="line">-- --------------------------------------------------------</span><br><span class="line"></span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET NAMES utf8 */;</span><br><span class="line">/*!50503 SET NAMES utf8mb4 */;</span><br><span class="line">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;</span><br><span class="line">/*!40103 SET TIME_ZONE='+00:00' */;</span><br><span class="line">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;</span><br><span class="line">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;</span><br><span class="line">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- 导出 nacos 的数据库结构</span><br><span class="line">DROP DATABASE IF EXISTS `nacos`;</span><br><span class="line">CREATE DATABASE IF NOT EXISTS `nacos` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci */ /*!80016 DEFAULT ENCRYPTION='N' */;</span><br><span class="line">USE `nacos`;</span><br><span class="line"></span><br><span class="line">-- 导出  表 nacos.config_info 结构</span><br><span class="line">DROP TABLE IF EXISTS `config_info`;</span><br><span class="line">CREATE TABLE IF NOT EXISTS `config_info` (</span><br><span class="line">  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id',</span><br><span class="line">  `data_id` varchar(255) COLLATE utf8_bin NOT NULL COMMENT 'data_id',</span><br><span class="line">  `group_id` varchar(128) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `content` longtext COLLATE utf8_bin NOT NULL COMMENT 'content',</span><br><span class="line">  `md5` varchar(32) COLLATE utf8_bin DEFAULT NULL COMMENT 'md5',</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',</span><br><span class="line">  `src_user` text COLLATE utf8_bin COMMENT 'source user',</span><br><span class="line">  `src_ip` varchar(50) COLLATE utf8_bin DEFAULT NULL COMMENT 'source ip',</span><br><span class="line">  `app_name` varchar(128) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `tenant_id` varchar(128) COLLATE utf8_bin DEFAULT '' COMMENT '租户字段',</span><br><span class="line">  `c_desc` varchar(256) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `c_use` varchar(64) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `effect` varchar(64) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `type` varchar(64) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `c_schema` text COLLATE utf8_bin,</span><br><span class="line">  `encrypted_data_key` text COLLATE utf8_bin NOT NULL COMMENT '秘钥',</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8_bin COMMENT='config_info';</span><br><span class="line"></span><br><span class="line">-- 正在导出表  nacos.config_info 的数据：~0 rows (大约)</span><br><span class="line">DELETE FROM `config_info`;</span><br><span class="line"></span><br><span class="line">-- 导出  表 nacos.config_info_aggr 结构</span><br><span class="line">DROP TABLE IF EXISTS `config_info_aggr`;</span><br><span class="line">CREATE TABLE IF NOT EXISTS `config_info_aggr` (</span><br><span class="line">  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id',</span><br><span class="line">  `data_id` varchar(255) COLLATE utf8_bin NOT NULL COMMENT 'data_id',</span><br><span class="line">  `group_id` varchar(128) COLLATE utf8_bin NOT NULL COMMENT 'group_id',</span><br><span class="line">  `datum_id` varchar(255) COLLATE utf8_bin NOT NULL COMMENT 'datum_id',</span><br><span class="line">  `content` longtext COLLATE utf8_bin NOT NULL COMMENT '内容',</span><br><span class="line">  `gmt_modified` datetime NOT NULL COMMENT '修改时间',</span><br><span class="line">  `app_name` varchar(128) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `tenant_id` varchar(128) COLLATE utf8_bin DEFAULT '' COMMENT '租户字段',</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8_bin COMMENT='增加租户字段';</span><br><span class="line"></span><br><span class="line">-- 正在导出表  nacos.config_info_aggr 的数据：~0 rows (大约)</span><br><span class="line">DELETE FROM `config_info_aggr`;</span><br><span class="line"></span><br><span class="line">-- 导出  表 nacos.config_info_beta 结构</span><br><span class="line">DROP TABLE IF EXISTS `config_info_beta`;</span><br><span class="line">CREATE TABLE IF NOT EXISTS `config_info_beta` (</span><br><span class="line">  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id',</span><br><span class="line">  `data_id` varchar(255) COLLATE utf8_bin NOT NULL COMMENT 'data_id',</span><br><span class="line">  `group_id` varchar(128) COLLATE utf8_bin NOT NULL COMMENT 'group_id',</span><br><span class="line">  `app_name` varchar(128) COLLATE utf8_bin DEFAULT NULL COMMENT 'app_name',</span><br><span class="line">  `content` longtext COLLATE utf8_bin NOT NULL COMMENT 'content',</span><br><span class="line">  `beta_ips` varchar(1024) COLLATE utf8_bin DEFAULT NULL COMMENT 'betaIps',</span><br><span class="line">  `md5` varchar(32) COLLATE utf8_bin DEFAULT NULL COMMENT 'md5',</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',</span><br><span class="line">  `src_user` text COLLATE utf8_bin COMMENT 'source user',</span><br><span class="line">  `src_ip` varchar(50) COLLATE utf8_bin DEFAULT NULL COMMENT 'source ip',</span><br><span class="line">  `tenant_id` varchar(128) COLLATE utf8_bin DEFAULT '' COMMENT '租户字段',</span><br><span class="line">  `encrypted_data_key` text COLLATE utf8_bin NOT NULL COMMENT '秘钥',</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8_bin COMMENT='config_info_beta';</span><br><span class="line"></span><br><span class="line">-- 正在导出表  nacos.config_info_beta 的数据：~0 rows (大约)</span><br><span class="line">DELETE FROM `config_info_beta`;</span><br><span class="line"></span><br><span class="line">-- 导出  表 nacos.config_info_tag 结构</span><br><span class="line">DROP TABLE IF EXISTS `config_info_tag`;</span><br><span class="line">CREATE TABLE IF NOT EXISTS `config_info_tag` (</span><br><span class="line">  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id',</span><br><span class="line">  `data_id` varchar(255) COLLATE utf8_bin NOT NULL COMMENT 'data_id',</span><br><span class="line">  `group_id` varchar(128) COLLATE utf8_bin NOT NULL COMMENT 'group_id',</span><br><span class="line">  `tenant_id` varchar(128) COLLATE utf8_bin DEFAULT '' COMMENT 'tenant_id',</span><br><span class="line">  `tag_id` varchar(128) COLLATE utf8_bin NOT NULL COMMENT 'tag_id',</span><br><span class="line">  `app_name` varchar(128) COLLATE utf8_bin DEFAULT NULL COMMENT 'app_name',</span><br><span class="line">  `content` longtext COLLATE utf8_bin NOT NULL COMMENT 'content',</span><br><span class="line">  `md5` varchar(32) COLLATE utf8_bin DEFAULT NULL COMMENT 'md5',</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',</span><br><span class="line">  `src_user` text COLLATE utf8_bin COMMENT 'source user',</span><br><span class="line">  `src_ip` varchar(50) COLLATE utf8_bin DEFAULT NULL COMMENT 'source ip',</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8_bin COMMENT='config_info_tag';</span><br><span class="line"></span><br><span class="line">-- 正在导出表  nacos.config_info_tag 的数据：~0 rows (大约)</span><br><span class="line">DELETE FROM `config_info_tag`;</span><br><span class="line"></span><br><span class="line">-- 导出  表 nacos.config_tags_relation 结构</span><br><span class="line">DROP TABLE IF EXISTS `config_tags_relation`;</span><br><span class="line">CREATE TABLE IF NOT EXISTS `config_tags_relation` (</span><br><span class="line">  `id` bigint NOT NULL COMMENT 'id',</span><br><span class="line">  `tag_name` varchar(128) COLLATE utf8_bin NOT NULL COMMENT 'tag_name',</span><br><span class="line">  `tag_type` varchar(64) COLLATE utf8_bin DEFAULT NULL COMMENT 'tag_type',</span><br><span class="line">  `data_id` varchar(255) COLLATE utf8_bin NOT NULL COMMENT 'data_id',</span><br><span class="line">  `group_id` varchar(128) COLLATE utf8_bin NOT NULL COMMENT 'group_id',</span><br><span class="line">  `tenant_id` varchar(128) COLLATE utf8_bin DEFAULT '' COMMENT 'tenant_id',</span><br><span class="line">  `nid` bigint NOT NULL AUTO_INCREMENT,</span><br><span class="line">  PRIMARY KEY (`nid`),</span><br><span class="line">  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8_bin COMMENT='config_tag_relation';</span><br><span class="line"></span><br><span class="line">-- 正在导出表  nacos.config_tags_relation 的数据：~0 rows (大约)</span><br><span class="line">DELETE FROM `config_tags_relation`;</span><br><span class="line"></span><br><span class="line">-- 导出  表 nacos.group_capacity 结构</span><br><span class="line">DROP TABLE IF EXISTS `group_capacity`;</span><br><span class="line">CREATE TABLE IF NOT EXISTS `group_capacity` (</span><br><span class="line">  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',</span><br><span class="line">  `group_id` varchar(128) COLLATE utf8_bin NOT NULL DEFAULT '' COMMENT 'Group ID，空字符表示整个集群',</span><br><span class="line">  `quota` int unsigned NOT NULL DEFAULT '0' COMMENT '配额，0表示使用默认值',</span><br><span class="line">  `usage` int unsigned NOT NULL DEFAULT '0' COMMENT '使用量',</span><br><span class="line">  `max_size` int unsigned NOT NULL DEFAULT '0' COMMENT '单个配置大小上限，单位为字节，0表示使用默认值',</span><br><span class="line">  `max_aggr_count` int unsigned NOT NULL DEFAULT '0' COMMENT '聚合子配置最大个数，，0表示使用默认值',</span><br><span class="line">  `max_aggr_size` int unsigned NOT NULL DEFAULT '0' COMMENT '单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值',</span><br><span class="line">  `max_history_count` int unsigned NOT NULL DEFAULT '0' COMMENT '最大变更历史数量',</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_group_id` (`group_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8_bin COMMENT='集群、各Group容量信息表';</span><br><span class="line"></span><br><span class="line">-- 正在导出表  nacos.group_capacity 的数据：~0 rows (大约)</span><br><span class="line">DELETE FROM `group_capacity`;</span><br><span class="line"></span><br><span class="line">-- 导出  表 nacos.his_config_info 结构</span><br><span class="line">DROP TABLE IF EXISTS `his_config_info`;</span><br><span class="line">CREATE TABLE IF NOT EXISTS `his_config_info` (</span><br><span class="line">  `id` bigint unsigned NOT NULL,</span><br><span class="line">  `nid` bigint unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `data_id` varchar(255) COLLATE utf8_bin NOT NULL,</span><br><span class="line">  `group_id` varchar(128) COLLATE utf8_bin NOT NULL,</span><br><span class="line">  `app_name` varchar(128) COLLATE utf8_bin DEFAULT NULL COMMENT 'app_name',</span><br><span class="line">  `content` longtext COLLATE utf8_bin NOT NULL,</span><br><span class="line">  `md5` varchar(32) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  `src_user` text COLLATE utf8_bin,</span><br><span class="line">  `src_ip` varchar(50) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `op_type` char(10) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  `tenant_id` varchar(128) COLLATE utf8_bin DEFAULT '' COMMENT '租户字段',</span><br><span class="line">  `encrypted_data_key` text COLLATE utf8_bin NOT NULL COMMENT '秘钥',</span><br><span class="line">  PRIMARY KEY (`nid`),</span><br><span class="line">  KEY `idx_gmt_create` (`gmt_create`),</span><br><span class="line">  KEY `idx_gmt_modified` (`gmt_modified`),</span><br><span class="line">  KEY `idx_did` (`data_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8_bin COMMENT='多租户改造';</span><br><span class="line"></span><br><span class="line">-- 正在导出表  nacos.his_config_info 的数据：~0 rows (大约)</span><br><span class="line">DELETE FROM `his_config_info`;</span><br><span class="line"></span><br><span class="line">-- 导出  表 nacos.permissions 结构</span><br><span class="line">DROP TABLE IF EXISTS `permissions`;</span><br><span class="line">CREATE TABLE IF NOT EXISTS `permissions` (</span><br><span class="line">  `role` varchar(50) COLLATE utf8mb4_general_ci NOT NULL,</span><br><span class="line">  `resource` varchar(255) COLLATE utf8mb4_general_ci NOT NULL,</span><br><span class="line">  `action` varchar(8) COLLATE utf8mb4_general_ci NOT NULL,</span><br><span class="line">  UNIQUE KEY `uk_role_permission` (`role`,`resource`,`action`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;</span><br><span class="line"></span><br><span class="line">-- 正在导出表  nacos.permissions 的数据：~0 rows (大约)</span><br><span class="line">DELETE FROM `permissions`;</span><br><span class="line"></span><br><span class="line">-- 导出  表 nacos.roles 结构</span><br><span class="line">DROP TABLE IF EXISTS `roles`;</span><br><span class="line">CREATE TABLE IF NOT EXISTS `roles` (</span><br><span class="line">  `username` varchar(50) COLLATE utf8mb4_general_ci NOT NULL,</span><br><span class="line">  `role` varchar(50) COLLATE utf8mb4_general_ci NOT NULL,</span><br><span class="line">  UNIQUE KEY `idx_user_role` (`username`,`role`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;</span><br><span class="line"></span><br><span class="line">-- 正在导出表  nacos.roles 的数据：~1 rows (大约)</span><br><span class="line">DELETE FROM `roles`;</span><br><span class="line">INSERT INTO `roles` (`username`, `role`) VALUES</span><br><span class="line">	('nacos', 'ROLE_ADMIN');</span><br><span class="line"></span><br><span class="line">-- 导出  表 nacos.tenant_capacity 结构</span><br><span class="line">DROP TABLE IF EXISTS `tenant_capacity`;</span><br><span class="line">CREATE TABLE IF NOT EXISTS `tenant_capacity` (</span><br><span class="line">  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',</span><br><span class="line">  `tenant_id` varchar(128) COLLATE utf8_bin NOT NULL DEFAULT '' COMMENT 'Tenant ID',</span><br><span class="line">  `quota` int unsigned NOT NULL DEFAULT '0' COMMENT '配额，0表示使用默认值',</span><br><span class="line">  `usage` int unsigned NOT NULL DEFAULT '0' COMMENT '使用量',</span><br><span class="line">  `max_size` int unsigned NOT NULL DEFAULT '0' COMMENT '单个配置大小上限，单位为字节，0表示使用默认值',</span><br><span class="line">  `max_aggr_count` int unsigned NOT NULL DEFAULT '0' COMMENT '聚合子配置最大个数',</span><br><span class="line">  `max_aggr_size` int unsigned NOT NULL DEFAULT '0' COMMENT '单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值',</span><br><span class="line">  `max_history_count` int unsigned NOT NULL DEFAULT '0' COMMENT '最大变更历史数量',</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8_bin COMMENT='租户容量信息表';</span><br><span class="line"></span><br><span class="line">-- 正在导出表  nacos.tenant_capacity 的数据：~0 rows (大约)</span><br><span class="line">DELETE FROM `tenant_capacity`;</span><br><span class="line"></span><br><span class="line">-- 导出  表 nacos.tenant_info 结构</span><br><span class="line">DROP TABLE IF EXISTS `tenant_info`;</span><br><span class="line">CREATE TABLE IF NOT EXISTS `tenant_info` (</span><br><span class="line">  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id',</span><br><span class="line">  `kp` varchar(128) COLLATE utf8_bin NOT NULL COMMENT 'kp',</span><br><span class="line">  `tenant_id` varchar(128) COLLATE utf8_bin DEFAULT '' COMMENT 'tenant_id',</span><br><span class="line">  `tenant_name` varchar(128) COLLATE utf8_bin DEFAULT '' COMMENT 'tenant_name',</span><br><span class="line">  `tenant_desc` varchar(256) COLLATE utf8_bin DEFAULT NULL COMMENT 'tenant_desc',</span><br><span class="line">  `create_source` varchar(32) COLLATE utf8_bin DEFAULT NULL COMMENT 'create_source',</span><br><span class="line">  `gmt_create` bigint NOT NULL COMMENT '创建时间',</span><br><span class="line">  `gmt_modified` bigint NOT NULL COMMENT '修改时间',</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8_bin COMMENT='tenant_info';</span><br><span class="line"></span><br><span class="line">-- 正在导出表  nacos.tenant_info 的数据：~0 rows (大约)</span><br><span class="line">DELETE FROM `tenant_info`;</span><br><span class="line"></span><br><span class="line">-- 导出  表 nacos.users 结构</span><br><span class="line">DROP TABLE IF EXISTS `users`;</span><br><span class="line">CREATE TABLE IF NOT EXISTS `users` (</span><br><span class="line">  `username` varchar(50) COLLATE utf8mb4_general_ci NOT NULL,</span><br><span class="line">  `password` varchar(500) COLLATE utf8mb4_general_ci NOT NULL,</span><br><span class="line">  `enabled` tinyint(1) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`username`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;</span><br><span class="line"></span><br><span class="line">-- 正在导出表  nacos.users 的数据：~1 rows (大约)</span><br><span class="line">DELETE FROM `users`;</span><br><span class="line">INSERT INTO `users` (`username`, `password`, `enabled`) VALUES</span><br><span class="line">	('nacos', '$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu', 1);</span><br><span class="line"></span><br><span class="line">/*!40103 SET TIME_ZONE=IFNULL(@OLD_TIME_ZONE, 'system') */;</span><br><span class="line">/*!40101 SET SQL_MODE=IFNULL(@OLD_SQL_MODE, '') */;</span><br><span class="line">/*!40014 SET FOREIGN_KEY_CHECKS=IFNULL(@OLD_FOREIGN_KEY_CHECKS, 1) */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40111 SET SQL_NOTES=IFNULL(@OLD_SQL_NOTES, 1) */;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>





<p>其中的<code>nacos/custom.env</code>文件中，有一个MYSQL_SERVICE_HOST也就是mysql地址</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">PREFER_HOST_MODE</span>=<span class="string">hostname</span></span><br><span class="line"><span class="attr">MODE</span>=<span class="string">standalone</span></span><br><span class="line"><span class="attr">SPRING_DATASOURCE_PLATFORM</span>=<span class="string">mysql</span></span><br><span class="line"><span class="attr">MYSQL_SERVICE_HOST</span>=<span class="string">192.168.87.132</span></span><br><span class="line"><span class="attr">MYSQL_SERVICE_DB_NAME</span>=<span class="string">nacos</span></span><br><span class="line"><span class="attr">MYSQL_SERVICE_PORT</span>=<span class="string">3306</span></span><br><span class="line"><span class="attr">MYSQL_SERVICE_USER</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">MYSQL_SERVICE_PASSWORD</span>=<span class="string">123</span></span><br><span class="line"><span class="attr">MYSQL_SERVICE_DB_PARAM</span>=<span class="string">characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useSSL=false&amp;allowPublicKeyRetrieval=true&amp;serverTimezone=Asia/Shanghai</span></span><br></pre></td></tr></tbody></table></figure>

<p>使用docker进行部署</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name nacos \</span><br><span class="line">--env-file ./nacos/custom.env \</span><br><span class="line">-p 8848:8848 \</span><br><span class="line">-p 9848:9848 \</span><br><span class="line">-p 9849:9849 \</span><br><span class="line">--restart=always \</span><br><span class="line">nacos/nacos-server:v2.1.0-slim</span><br></pre></td></tr></tbody></table></figure>

<p>Java项目中添加下列依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos 服务注册发现--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>yml配置</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">item-service</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.78</span><span class="number">.132</span><span class="string">:8848</span> <span class="comment"># nacos地址</span></span><br></pre></td></tr></tbody></table></figure>

<p>启动项目后就可以看到nacos控制台中,服务列表有对应内容.</p>
<h4 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h4><p>服务的消费者要去nacos订阅服务，这个过程就是服务发现，步骤如下：</p>
<ul>
<li>引入依赖</li>
<li>配置Nacos地址</li>
<li>发现并调用服务</li>
</ul>
<p><strong>提供者和消费者都需要在nacos中进行注册</strong></p>
<p>服务发现需要用到一个工具，DiscoveryClient，SpringCloud已经帮我们自动装配，我们可以直接注入使用：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=YTRkOGM5MzZmNGI0ZWY1N2FjMzg4MjQzNTVkMWIyNzlfYTlOQW1ZV2lEUTY1d2dhTEp6c3BlSUQ0cVBzdUtTR2NfVG9rZW46TVhydGJIWHNEb1JEU0p4cXdRQ2NsNDlVbm1lXzE3MTQ4MTI0NTk6MTcxNDgxNjA1OV9WNA" alt="img"></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//根据服务名称从注册中心拉取实例</span></span><br><span class="line">     List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">"item-service"</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//随机选择一个实例</span></span><br><span class="line">     <span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> instances.get(RandomUtil.randomInt(instances.size()));</span><br><span class="line">     <span class="comment">//获取实例的端口地址</span></span><br><span class="line">     <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> instance.getUri();</span><br><span class="line">    ResponseEntity&lt;List&lt;ItemDTO&gt;&gt; exchange = restTemplate.exchange(</span><br><span class="line">             uri+<span class="string">"/items?ids={ids}"</span>,</span><br><span class="line">             HttpMethod.GET,</span><br><span class="line">             <span class="literal">null</span>,</span><br><span class="line">             <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;List&lt;ItemDTO&gt;&gt;() {</span><br><span class="line">             },</span><br><span class="line">            Map.of(<span class="string">"ids"</span> ,CollUtils.join(itemIds, <span class="string">","</span>))</span><br><span class="line">     );</span><br></pre></td></tr></tbody></table></figure>

<p>这里主要就是能实现动态化.有新服务的时候可以得知,服务死了也能得知并更换.且无需重启项目!(这里的原理我觉得有必要了解一下)</p>
<h3 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="OpenFeign"></a>OpenFeign</h3><p>使用RestTemplate加上Nacos后虽然灵活,但是感觉挺麻烦的,而且由于灵活的话,包装为一个函数感觉更不太容易了.</p>
<p>所以可以使用接口的形式进行统一.</p>
<p>我感觉更重要的是,微服务调用更偏向于本地调用,用Rest Template调用浏览器那些更舒服.</p>
<p>远程调用的关键点就在于四个：</p>
<ul>
<li>请求方式</li>
<li>请求路径</li>
<li>请求参数</li>
<li>返回值类型</li>
</ul>
<p>OpenFeign就利用SpringMVC的相关注解来声明上述4个参数，然后基于动态代理帮我们生成远程调用的代码，而无需我们手动再编写，非常方便。</p>
<p><code>OpenFeign</code>的依赖和<code>loadBalancer</code>依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--openFeign--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--负载均衡器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>启动类上添加注解，启动OpenFeign功能：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=OGFiOGEyYTVjOGRmZjQ1ZTYwMmFkYzQ3MjY1M2I0YzBfTktmNUdWMXZ6VW1TVlBsS05UdDN1dHY0ejFZOEZteDNfVG9rZW46SnNnbGJTNG5Ebzl4RnV4S2JQQmNMYkRubjFmXzE3MTQ4MTI5OTQ6MTcxNDgxNjU5NF9WNA" alt="img"></p>
<h4 id="OpenFeign客户端"><a href="#OpenFeign客户端" class="headerlink" title="OpenFeign客户端"></a>OpenFeign客户端</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = "item-service", // 服务名称,在Application.yaml中有配置</span></span><br><span class="line"><span class="meta">        configuration = DefaultConfig.class,  </span></span><br><span class="line"><span class="meta">        fallbackFactory = ItemClientFallback.class)</span> <span class="comment">//后话了,回调函数.服务熔断会使用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ItemClient</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/items")</span>  <span class="comment">//请求路径</span></span><br><span class="line">    List&lt;ItemDTO&gt; <span class="title function_">queryItemByIds</span><span class="params">(<span class="meta">@RequestParam</span> Collection&lt;Long&gt; ids)</span>;</span><br><span class="line">    <span class="meta">@PutMapping("/items/stock/deduct")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductStock</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;OrderDetailDTO&gt;items)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>可以看到,跟mvc的使用很类似.</p>
<p>其他服务调用时只需要依赖注入ItemClient,然后就能直接进行使用</p>
<h4 id="连接池-了解"><a href="#连接池-了解" class="headerlink" title="连接池(了解?)"></a>连接池(了解?)</h4><p>Feign底层发起http请求，依赖于其它的框架。其底层支持的http客户端实现包括：</p>
<ul>
<li>HttpURLConnection：默认实现，不支持连接池</li>
<li>Apache HttpClient ：支持连接池</li>
<li>OKHttp：支持连接池</li>
</ul>
<p>因此我们通常会使用带有连接池的客户端来代替默认的HttpURLConnection。比如，我们使用OK Http.</p>
<p>在<code>cart-service</code>的<code>pom.xml</code>中引入依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--OK http 的依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>在<code>cart-service</code>的<code>application.yml</code>配置文件中开启Feign的连接池功能：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启OKHttp功能</span></span><br></pre></td></tr></tbody></table></figure>

<p>重启服务，连接池就生效了。</p>
<h3 id="抽取客户端"><a href="#抽取客户端" class="headerlink" title="抽取客户端"></a>抽取客户端</h3><p>刚刚的实践中不难发现,由于服务之间已经隔离,采用http远程调用就能获取数据了,但是的话就算使用Openfegin后代码仍会很冗余,毕竟远程调用的地方很多,那代码重复也会很多,我们需要在每个微服务都建立很多个客户端?</p>
<p>避免重复编码的办法就是<strong>抽取</strong>。不过这里有两种抽取思路：</p>
<ul>
<li>思路1：抽取到微服务之外的公共module</li>
<li>思路2：每个微服务自己抽取一个module</li>
</ul>
<p>如图：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=NTBlNjgyMzAzMzIxZmYwMTVlYjFkYTk3OTMxZDM2ZDZfR05zaHN3amRIbERKWGpQdHFkM2h5Vk9SM1dZOEhlMnBfVG9rZW46T2w3N2JNOEZib1pmN2R4aDR5dmNOWVRBblFoXzE3MTQ4MTM1ODI6MTcxNDgxNzE4Ml9WNA" alt="img"></p>
<p>方案1抽取更加简单，工程结构也比较清晰，但缺点是整个项目耦合度偏高。</p>
<p>方案2抽取相对麻烦，工程结构相对更复杂，但服务之间耦合度降低。</p>
<p>第一种的话我是比较喜欢的,虽然会引入其他用不着的客户端.第二种感觉pom文件会很不得了.</p>
<p>(其实吧,是快速入门用第一种,两种还是根据实际情况分析)</p>
<p>第一种也有点冗余的,毕竟你得把dto也搞到api模块里面,所以第二种感觉适合大型项目</p>
<p><strong>使用时,在service的启动类上添加声明即可，两种方式：</strong></p>
<ul>
<li>方式1：声明扫描包：</li>
</ul>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2I3ZWU5NmU2MGYxY2NlMzVhYzExMGUyNDcwMmU4MmVfQ1Jkek5kTnZhMlh3MEgwY1Q2ajRSMjdQSElNMTY1MWZfVG9rZW46SEhHdGJseFVhb3JvdGF4bzNwNGNMa0ZzbkVjXzE3MTQ4MTM5NDc6MTcxNDgxNzU0N19WNA" alt="img"></p>
<ul>
<li>方式2：声明要用的FeignClient</li>
</ul>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=MDRkMzQ1YTgyNzA2ZmNiYTVlYWRkNWJlNGI3OGRlMmJfSzVOT2xURG11M1BmWWEzWFNncENIREVMY1JqbEJCTmpfVG9rZW46TmU0OWJWU3VobzlKY3Z4MkNOeWNPd0kybnlnXzE3MTQ4MTM5NDc6MTcxNDgxNzU0N19WNA" alt="img"></p>
<h2 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h2><p>在微服务中,用户登录后得到的jwt令牌怎么传递是个问题.当然使用redis存储是个办法(我个人想到的是这种方法)</p>
<h3 id="认识网关"><a href="#认识网关" class="headerlink" title="认识网关"></a>认识网关</h3><p>顾明思议，网关就是<strong>网</strong>络的<strong>关</strong>口。数据在网络间传输，从一个网络传输到另一网络时就需要经过网关来做数据的<strong>路由和转发以及数据安全的校验</strong>。</p>
<p>更通俗的来讲，网关就像是以前园区传达室的大爷。</p>
<ul>
<li>外面的人要想进入园区，必须经过大爷的认可，如果你是不怀好意的人，肯定被直接拦截。</li>
<li>外面的人要传话或送信，要找大爷。大爷帮你带给目标人。</li>
</ul>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=M2YyMDQwYjViMjYxYzM3NjI3OTc0ZTdjOTRkYTU3ZGVfdDFBTVJabGJmcGE0QU9CendCam1qZ1NlTzlNUW5ndzNfVG9rZW46TU9tZWJQTjhob1RDVmh4TjF0VGNicVVobmdoXzE3MTQ4MTQxOTU6MTcxNDgxNzc5NV9WNA" alt="img"></p>
<p>现在，微服务网关就起到同样的作用。前端请求不能直接访问微服务，而是要请求网关：</p>
<ul>
<li>网关可以做安全控制，也就是登录身份校验，校验通过才放行</li>
<li>通过认证后，网关再根据请求判断应该访问哪个微服务，将请求转发过去</li>
</ul>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=YzljYjRjM2Y0ZDhjMjgxNDU3YjM3MTkwYjYzYTdiN2FfN3hxOGczQ3BiVXpiTks4bWJNV096WjVQVVhtMWJCeVVfVG9rZW46WFdmaWJuMUpKb0loM0x4V21SdGNneHVsbm9lXzE3MTQ4MTQxOTU6MTcxNDgxNzc5NV9WNA" alt="img"></p>
<p>感觉有点类似于设计模式的门卫模式?</p>
<p>O(∩_∩)O</p>
<p>我们这里采用SpringcloudGateway实现网关功能</p>
<ul>
<li>SpringCloudGateway：基于Spring的WebFlux技术，完全支持响应式编程，吞吐能力更强</li>
</ul>
<p>官方网站：</p>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-gateway#learn">https://spring.io/projects/spring-cloud-gateway#learn</a></p>
<p><strong>大概步骤如下：</strong></p>
<ul>
<li>创建网关微服务</li>
<li>引入SpringCloudGateway、NacosDiscovery依赖</li>
<li>编写启动类</li>
<li>配置网关路由</li>
</ul>
<p>额,可以发现,又用到了nacos.毕竟守门老大爷也需要知道名册表查询啊.</p>
<p>gateway模块引入依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hm-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--common--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.heima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hm-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--网关--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--nacos discovery--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--负载均衡--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>${project.artifactId}<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3 id="配置路由"><a href="#配置路由" class="headerlink" title="配置路由"></a>配置路由</h3><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">server:</span> </span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span>  <span class="string">//正好前端请求的是8080端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">item</span> <span class="comment"># 路由规则id，自定义，唯一</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://item-service</span> <span class="comment"># 路由的目标服务，lb代表负载均衡，会从注册中心拉取服务列表</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由断言，判断当前请求是否符合当前规则，符合则路由到目标服务</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/items/**,/search/**</span> <span class="comment"># 这里是以请求路径作为判断规则</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cart</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cart-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/carts/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://user-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/users/**,/addresses/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">trade</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://trade-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/orders/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">pay</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://pay-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/pay-orders/**</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<h3 id="路由过滤"><a href="#路由过滤" class="headerlink" title="路由过滤"></a>路由过滤</h3><p>这里的话就耗子尾汁吧.感觉没怎么用上这里.</p>
<p>感觉后面可以做很多文章.这种加请求头,和过滤啊什么的</p>
<h2 id="网关登录校验"><a href="#网关登录校验" class="headerlink" title="网关登录校验"></a>网关登录校验</h2><p>单体架构时我们只需要完成一次用户登录、身份校验，就可以在所有业务中获取到用户信息。而微服务拆分后，每个微服务都独立部署，不再共享数据。也就意味着每个微服务都需要做登录校验，这显然不可取。</p>
<h2 id="鉴权思路分析"><a href="#鉴权思路分析" class="headerlink" title="鉴权思路分析"></a>鉴权思路分析</h2><p>我们的登录是基于JWT来实现的，校验JWT的算法复杂，而且需要用到秘钥。如果每个微服务都去做登录校验，这就存在着两大问题：</p>
<ul>
<li>每个微服务都需要知道JWT的秘钥，不安全</li>
<li>每个微服务重复编写登录校验代码、权限校验代码，麻烦</li>
</ul>
<p>既然网关是所有微服务的入口，一切请求都需要先经过网关。我们完全可以把登录校验的工作放到网关去做，这样之前说的问题就解决了：</p>
<ul>
<li>只需要在网关和用户服务保存秘钥</li>
<li>只需要在网关开发登录校验功能</li>
</ul>
<p>此时，登录校验的流程如图：</p>
<p><img src="https://img2.imgtp.com/2024/05/04/fy1GYbNn.png" alt="img"></p>
<p>不过这里存在问题:</p>
<ul>
<li>网关路由是配置的，请求转发是Gateway内部代码，我们如何在转发之前做登录校验？</li>
<li>网关校验JWT之后，如何将用户信息传递给微服务？</li>
<li>微服务之间也会相互调用，这种调用不经过网关，又该如何传递用户信息？</li>
</ul>
<h4 id="网关过滤器"><a href="#网关过滤器" class="headerlink" title="网关过滤器"></a>网关过滤器</h4><p>登录校验必须在请求转发到微服务之前做，否则就失去了意义。而网关的请求转发是<code>Gateway</code>内部代码实现的，要想在请求转发之前做登录校验，就必须了解<code>Gateway</code>内部工作的基本原理。</p>
<p><img src="https://img2.imgtp.com/2024/05/04/R3khRwWh.png" alt="img"></p>
<ol>
<li>客户端请求进入网关后由<code>HandlerMapping</code>对请求做判断，找到与当前请求匹配的路由规则（**<code>Route</code>**），然后将请求交给<code>WebHandler</code>去处理。</li>
<li><code>WebHandler</code>则会加载当前路由下需要执行的过滤器链（**<code>Filter chain</code><strong>），然后按照顺序逐一执行过滤器（后面称为</strong><code>Filter</code>**）。</li>
<li>图中<code>Filter</code>被虚线分为左右两部分，是因为<code>Filter</code>内部的逻辑分为<code>pre</code>和<code>post</code>两部分，分别会在请求路由到微服务<strong>之前</strong>和<strong>之后</strong>被执行。</li>
<li>只有所有<code>Filter</code>的<code>pre</code>逻辑都依次顺序执行通过后，请求才会被路由到微服务。</li>
<li>微服务返回结果后，再倒序执行<code>Filter</code>的<code>post</code>逻辑。</li>
<li>最终把响应结果返回。</li>
</ol>
<p>如图中所示，最终请求转发是有一个名为<code>NettyRoutingFilter</code>的过滤器来执行的，而且这个过滤器是整个过滤器链中顺序最靠后的一个。<strong>如果我们能够定义一个过滤器，在其中实现登录校验逻辑，并且将过滤器执行顺序定义到</strong><code>NettyRoutingFilter</code>之前，这就符合我们的需求了！</p>
<p>网关过滤器链中的过滤器有两种：</p>
<ul>
<li>**<code>GatewayFilter</code>**：路由过滤器，作用范围比较灵活，可以是任意指定的路由<code>Route</code>. </li>
<li>**<code>GlobalFilter</code>**：全局过滤器，作用范围是所有路由，不可配置。</li>
</ul>
<p><code>Gateway</code>中内置了很多的<code>GatewayFilter</code>，详情可以参考官方文档：</p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/3.1.7/reference/html/#gatewayfilter-factories">https://docs.spring.io/spring-cloud-gateway/docs/3.1.7/reference/html/#gatewayfilter-factories</a></p>
<h5 id="自定义过滤器"><a href="#自定义过滤器" class="headerlink" title="自定义过滤器"></a>自定义过滤器</h5><p>自定义<code>GatewayFilter</code>不是直接实现<code>GatewayFilter</code>，而是实现<code>AbstractGatewayFilterFactory</code>。最简单的方式是这样的：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrintAnyGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractGatewayFilterFactory</span>&lt;Object&gt; {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GatewayFilter <span class="title function_">apply</span><span class="params">(Object config)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GatewayFilter</span>() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">                <span class="comment">// 获取请求</span></span><br><span class="line">                <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">                <span class="comment">// 编写过滤器逻辑</span></span><br><span class="line">                System.out.println(<span class="string">"过滤器执行了"</span>);</span><br><span class="line">                <span class="comment">// 放行</span></span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注意</strong>：该类的名称一定要以<code>GatewayFilterFactory</code>为后缀！</p>
<p>然后在yaml配置中这样使用：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">PrintAny</span> <span class="comment"># 此处直接以自定义的GatewayFilterFactory类名称前缀类声明过滤器</span></span><br></pre></td></tr></tbody></table></figure>

<p>动态参数配置这里就不说了,我也没怎么用到,还不大懂应用</p>
<h3 id="自定义GlobalFilter"><a href="#自定义GlobalFilter" class="headerlink" title="自定义GlobalFilter"></a>自定义GlobalFilter</h3><p>自定义GlobalFilter则简单很多，直接实现GlobalFilter即可，而且也无法设置动态参数：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrintAnyGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">        <span class="comment">// 编写过滤器逻辑</span></span><br><span class="line">        System.out.println(<span class="string">"未登录，无法访问"</span>);</span><br><span class="line">        <span class="comment">// 放行</span></span><br><span class="line">        <span class="comment">// return chain.filter(exchange);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拦截</span></span><br><span class="line">        <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">        response.setRawStatusCode(<span class="number">401</span>);</span><br><span class="line">        <span class="keyword">return</span> response.setComplete();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 过滤器执行顺序，值越小，优先级越高</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3 id="登录校验"><a href="#登录校验" class="headerlink" title="登录校验"></a>登录校验</h3><p>登录校验的过滤器感觉跟拦截器的写法也挺类似的</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JwtTool jwtTool; jwt工具</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span>  </span><br><span class="line">    <span class="keyword">private</span> AuthProperties authProperties;   <span class="comment">//路径配置,在yaml读取</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AntPathMatcher</span> <span class="variable">antPathMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>(); <span class="comment">//路径匹配的一个工具</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">        <span class="comment">//获取request</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line"><span class="comment">//        判断路径是否需要拦截</span></span><br><span class="line">        <span class="type">RequestPath</span> <span class="variable">path</span> <span class="operator">=</span> request.getPath();</span><br><span class="line">        List&lt;String&gt; excludePaths = authProperties.getExcludePaths();</span><br><span class="line">        <span class="keyword">if</span> (isExclude(path.toString())) {</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);<span class="comment">//放行</span></span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//获取请求头</span></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> request.getHeaders();</span><br><span class="line">        List&lt;String&gt; authorization = headers.get(<span class="string">"Authorization"</span>);</span><br><span class="line"></span><br><span class="line">        String token=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!CollUtils.isEmpty(authorization)){</span><br><span class="line">           token= authorization.get(<span class="number">0</span>);</span><br><span class="line">        }</span><br><span class="line"><span class="comment">//        log.error(token);</span></span><br><span class="line">        <span class="comment">//解析请求头获取用户信息</span></span><br><span class="line">        Long userId=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            userId = jwtTool.parseToken(token);</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">            response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> response.setComplete();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//信息传递</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userInfo</span> <span class="operator">=</span>userId.toString();</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"><span class="comment">//        System.out.println("userId = " + userId);</span></span><br><span class="line">        <span class="type">ServerWebExchange</span> <span class="variable">swe</span> <span class="operator">=</span> exchange.mutate().request(builder -&gt; builder.header(<span class="string">"user-info"</span>, userInfo))</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(swe);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isExclude</span><span class="params">(String path)</span> {</span><br><span class="line">        List&lt;String&gt; excludePaths = authProperties.getExcludePaths();</span><br><span class="line">        <span class="keyword">for</span> (String excludePath : excludePaths) {</span><br><span class="line">            <span class="keyword">if</span> (antPathMatcher.match(excludePath, path)) {</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 返回值越小优先级越高</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<h2 id="微服务获取用户信息"><a href="#微服务获取用户信息" class="headerlink" title="微服务获取用户信息"></a>微服务获取用户信息</h2><p>网关拦截方面实现了,但是微服务内部之间需要互相传递信息啊</p>
<p>由于网关发送请求到微服务依然采用的是<code>Http</code>请求，因此我们可以将用户信息以请求头的方式传递到下游微服务。然后微服务可以从请求头中获取登录用户信息。考虑到微服务内部可能很多地方都需要用到登录用户信息，因此我们可以利用SpringMVC的拦截器来实现登录用户信息获取，并存入ThreadLocal，方便后续使用。</p>
<p>据图流程图如下：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=M2MwZWFlY2FiZDFmZjFkMGRlNTkzNDQ1ZmQ4ZWY5NzFfRE01bkEzc0hIWXNkYXU5OHA3VG5iNmZ3VzM0emhuQVNfVG9rZW46S2h4RWI2cmpCb05yVkN4c2VoTGNGUExFblNkXzE3MTQ4MTgyOTA6MTcxNDgyMTg5MF9WNA" alt="img"></p>
<p>因此，接下来我们要做的事情有：</p>
<ul>
<li>改造网关过滤器，在获取用户信息后保存到请求头，转发到下游微服务(上面的代码已经携带了)</li>
<li>编写微服务拦截器，拦截请求获取用户信息，保存到ThreadLocal后放行</li>
</ul>
<p>在common模块中编写登录拦截器.</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(DispatcherServlet.class)</span><span class="comment">//自动装配条件,指定mvc</span></span><br><span class="line"><span class="comment">///DispatcherServlet 是 SpringMVC统一的入口，所有的请求都通过它</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> {</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">UserInfoInterceptor</span>());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfoInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">//获取用户信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userInfo</span> <span class="operator">=</span> request.getHeader(<span class="string">"user-Info"</span>);</span><br><span class="line">        <span class="comment">//是否获取用户，存入threadLocal</span></span><br><span class="line">        <span class="keyword">if</span>(StrUtil.isNotBlank(userInfo)){</span><br><span class="line">            UserContext.setUser(Long.valueOf(userInfo));</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        UserContext.removeUser();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><strong>需要注意的是，这个配置类默认是不会生效的，因为它所在的包是<code>com.hmall.common.config</code>，与其它微服务的扫描包不一致，无法被扫描到，因此无法生效。</strong></p>
<p>基于SpringBoot的自动装配原理，我们要将其添加到<code>resources</code>目录下的<code>META-INF/spring.factories</code>文件中：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=NGJmMjVlM2JjNGE4NTc4NTkzMmFlZjY3ZTY4YjJkYWZfREJyZVc0djR3ZWtxcVJTeHZEMmFEck1FTXVhT2lvdUlfVG9rZW46RlNyeWJtS1Jqb04xdWV4QUtCRGNFY3o2blZkXzE3MTQ4MTg1OTM6MTcxNDgyMjE5M19WNA" alt="img"></p>
<p>内容如下：</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">  com.hmall.common.config.MyBatisConfig,\</span></span><br><span class="line"><span class="string">  com.hmall.common.config.MvcConfig,\</span></span><br><span class="line"><span class="string">  com.hmall.common.config.JsonConfig</span></span><br></pre></td></tr></tbody></table></figure>







<h3 id="Openfegin传递用户"><a href="#Openfegin传递用户" class="headerlink" title="Openfegin传递用户"></a>Openfegin传递用户</h3><p>前端发起的请求都会经过网关再到微服务，由于我们之前编写的过滤器和拦截器功能，微服务可以轻松获取登录用户信息。</p>
<p>但有些业务是比较复杂的，请求到达微服务后还需要调用其它多个微服务。比如下单业务，流程如下：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=YTMxZmJjNTRmOTI0MDA0ODhmZWE4MDIyM2M3MDExNWFfbkxwNXlvczloUUlJRXBlWGJndmFVV2pmangxeTJSbWhfVG9rZW46WXA1WGI2ZWFQbzVWYlN4dFFzUGNCa0piblhsXzE3MTQ4MTg5NTM6MTcxNDgyMjU1M19WNA" alt="img"></p>
<p>下单的过程中，需要调用商品服务扣减库存，调用购物车服务清理用户购物车。而清理购物车时必须知道当前登录的用户身份。但是，<strong>订单服务调用购物车时并没有传递用户信息</strong>，购物车服务无法知道当前用户是谁！</p>
<p>由于微服务获取用户信息是通过拦截器在请求头中读取，因此要想实现微服务之间的用户信息传递，就<strong>必须在微服务发起调用时把用户信息存入请求头</strong>。</p>
<p>微服务之间调用是基于OpenFeign来实现的，并不是我们自己发送的请求。我们如何才能让每一个由OpenFeign发起的请求自动携带登录用户信息呢？</p>
<p>这里要借助Feign中提供的一个拦截器接口：<code>feign.RequestInterceptor</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RequestInterceptor</span> {</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called for every request. </span></span><br><span class="line"><span class="comment">   * Add data using methods on the supplied {<span class="doctag">@link</span> RequestTemplate}.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate template)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们只需要实现这个接口，然后实现apply方法，利用<code>RequestTemplate</code>类来添加请求头，将用户信息保存到请求头中。这样以来，每次OpenFeign发起请求的时候都会调用该方法，传递用户信息。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultConfig</span> {</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RequestInterceptor <span class="title function_">userInfoRequestInterceptor</span><span class="params">()</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RequestInterceptor</span>() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate template)</span> {</span><br><span class="line">            <span class="comment">// 获取登录用户</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserContext.getUser();</span><br><span class="line">            <span class="keyword">if</span>(userId == <span class="literal">null</span>) {</span><br><span class="line">                <span class="comment">// 如果为空则直接跳过</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 如果不为空则放入请求头中，传递给下游微服务</span></span><br><span class="line">            template.header(<span class="string">"user-info"</span>, userId.toString());</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Lambda简化(可读性感觉不太好,)</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultConfig</span> {</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RequestInterceptor <span class="title function_">userInfoRequestInterceptor</span><span class="params">()</span>{</span><br><span class="line">       <span class="keyword">return</span> requestTemplate -&gt; {</span><br><span class="line">           <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserContext.getUser();</span><br><span class="line">           <span class="keyword">if</span>(userId!=<span class="literal">null</span>){</span><br><span class="line">               requestTemplate.header(<span class="string">"user-info"</span>, userId.toString());</span><br><span class="line">           }</span><br><span class="line">       };</span><br><span class="line">   }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = "item-service",</span></span><br><span class="line"><span class="meta">        configuration = DefaultConfig.class)</span> <span class="comment">//配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ItemClient</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/items")</span></span><br><span class="line">    List&lt;ItemDTO&gt; <span class="title function_">queryItemByIds</span><span class="params">(<span class="meta">@RequestParam</span> Collection&lt;Long&gt; ids)</span>;</span><br><span class="line">    <span class="meta">@PutMapping("/items/stock/deduct")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductStock</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;OrderDetailDTO&gt;items)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<h2 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h2><p>我们已经解决微服务中几个问题了,小项目基本就ok了</p>
<ul>
<li>微服务之间的远程调用</li>
<li>微服务的注册和发现(nacos)</li>
<li>微服务请求路由和负载均衡</li>
<li>微服务之间用户信息传递</li>
</ul>
<p>现在依然还有几个问题需要解决：</p>
<ul>
<li>网关路由在配置文件中写死了，如果变更必须重启微服务</li>
<li>某些业务配置在配置文件中写死了，每次修改都要重启服务</li>
<li>每个微服务都有很多重复的配置，维护成本高</li>
</ul>
<p>这些问题都可以通过统一的<strong>配置管理器服务</strong>解决。而Nacos不仅仅具备注册中心功能，也具备配置管理的功能：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=YzI1YTA1N2FkODI3ZjNlNTVlODcwNjY5NWQ3OTIyNDhfcUxvTm9OT3R2OE5UcUREQXRLaEF4elo4c2VyeE9kak9fVG9rZW46RTZhSGI0MGdZb0RNMTF4TVVOS2M0YzZabnhmXzE3MTQ4MTk0NTU6MTcxNDgyMzA1NV9WNA" alt="img"></p>
<p>微服务共享的配置可以统一交给Nacos保存和管理，在Nacos控制台修改配置后，Nacos会将配置变更推送给相关的微服务，并且无需重启即可生效，实现配置热更新。</p>
<p>网关的路由同样是配置，因此同样可以基于这个功能实现动态路由功能，无需重启网关即可修改路由配置。</p>
<p>感觉有点小牛批哈这个nacos,但是它是怎么做到的,俺很好奇.</p>
<h3 id="配置共享"><a href="#配置共享" class="headerlink" title="配置共享"></a>配置共享</h3><p>我们可以把微服务共享的配置抽取到Nacos中统一管理，这样就不需要每个微服务都重复配置了。分为两步：</p>
<ul>
<li>在Nacos中添加共享配置</li>
<li>微服务拉取配置</li>
</ul>
<h3 id="添加共享配置"><a href="#添加共享配置" class="headerlink" title="添加共享配置"></a>添加共享配置</h3><p>以cart-service为例，我们看看有哪些配置是重复的，可以抽取的：</p>
<p>首先是jdbc相关配置：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=YTc2MDI0ODIxNjBhOWE2Zjk1MDgyNjk2YmNiOWE0NGNfajFoOFlGSHBxdDNkVkFQVnA3RXhKeXc0ZkxlWTJPOHNfVG9rZW46U0d6TGJjOU9ob21YckJ4THd5ZmNqT1I4blRiXzE3MTQ4MTk5NTg6MTcxNDgyMzU1OF9WNA" alt="img"></p>
<p>然后是日志配置：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=MzJmZDM5NGNkZGVlZGUyYTJjNjIzOWViMGZjYTE4ZDRfalpYN3hHcjZQQVBiaTJkVFcwenJjWENLeWxNRWJMSFZfVG9rZW46SER6WGJNb09ob3V6Wk54YjBzZGN0YzJNbnFnXzE3MTQ4MTk5NTg6MTcxNDgyMzU1OF9WNA" alt="img"></p>
<p>然后是swagger以及OpenFeign的配置：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=NTU0YzdlODYxYTZiYTQwZmNkOGU5M2QwYTVlNzM5ZTBfblp5bjZYSWkzR2tTR3pPMTk3Qk1pbEowNlpTVDN5UTlfVG9rZW46UkhrT2J0bG1jb2dHdTF4WFRsVWNlR2lsbm9iXzE3MTQ4MTk5NTg6MTcxNDgyMzU1OF9WNA" alt="img"></p>
<p>在nacos中添加相应的配置.</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTFjODBiZjhlYTUwMmJhMDhhNTY5OTQ3NWNkMjBhMTVfNVI2SlZ5Q05yMWQ3eUoyTEFRVk5OMXpCSHROSjVaaHRfVG9rZW46RU52YmJNMkNmb1dhVFh4MkJkUGNEanlzbkVjXzE3MTQ4MTk5ODE6MTcxNDgyMzU4MV9WNA" alt="img"></p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://${hm.db.host:192.168.87.132}:${hm.db.port:3306}/${hm.db.database}?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">${hm.db.un:root}</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">${hm.db.pw:123}</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">default-enum-type-handler:</span> <span class="string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br></pre></td></tr></tbody></table></figure>

<p>改为hm.db.host:192.168.87.132,即默认为虚拟机ip地址,但是有值的话就用配置的值</p>
<h3 id="拉取共享配置"><a href="#拉取共享配置" class="headerlink" title="拉取共享配置"></a>拉取共享配置</h3><p>接下来，我们要在微服务拉取共享配置。将拉取到的共享配置与本地的<code>application.yaml</code>配置合并，完成项目上下文的初始化。</p>
<p>不过，需要注意的是，读取Nacos配置是SpringCloud上下文（<code>ApplicationContext</code>）初始化时处理的，发生在项目的引导阶段。然后才会初始化SpringBoot上下文，去读取<code>application.yaml</code>。</p>
<p>也就是说引导阶段，<code>application.yaml</code>文件尚未读取，根本不知道nacos 地址，该如何去加载nacos中的配置文件呢？</p>
<p>SpringCloud在初始化上下文的时候会先读取一个名为<code>bootstrap.yaml</code>(或者<code>bootstrap.properties</code>)的文件，如果我们将nacos地址配置到<code>bootstrap.yaml</code>中，那么在项目引导阶段就可以读取nacos中的配置了。</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDQ2NjQxNmU3MmFjMTJhMTMxYmQ2NTYxOGU0OTBjYTZfZWJZd2RZaGRoTUVuTVJCcVQwWHhIR2Z3VjNYNHpoTnlfVG9rZW46TGlkdWJianlob0Y0c0t4RmR3S2NaWGNubldmXzE3MTQ4MjAxMDU6MTcxNDgyMzcwNV9WNA" alt="img"></p>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos配置管理--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--读取bootstrap文件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cart-service</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.87</span><span class="number">.132</span><span class="string">:8848</span>   <span class="comment">#nacos地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span>    <span class="comment"># 读取配置文件格式</span></span><br><span class="line">        <span class="attr">shared-configs:</span>      </span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">shared-log.yaml</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">shared-jdbc.yaml</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">shared-knife4j.yaml</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">shared-seata.yaml</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">shared-feign.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>到此application.yaml就可以简化为</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启OKHttp连接池支持</span></span><br><span class="line"><span class="attr">hm:</span></span><br><span class="line">  <span class="attr">swagger:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">购物车服务接口文档</span></span><br><span class="line">    <span class="attr">package:</span> <span class="string">com.hmall.cart.controller</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">hm-cart</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="配置热更新"><a href="#配置热更新" class="headerlink" title="配置热更新"></a>配置热更新</h3><p>有很多的业务相关参数，将来可能会根据实际情况临时调整。例如购物车业务，购物车数量有一个上限，默认是10，对应代码如下：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=MzNhOGU5ZWNlZWE0ZDhjOTBhNTI4OTkxYmIwYjZlNzlfdGRwREVjWnkzZXFLamU0ek9UZno1NnRJOUJRV0FZdVVfVG9rZW46R1FpOWJuNGF0b3M4bWZ4SHJPRGM1QXdIbkpmXzE3MTQ4MjAzMDE6MTcxNDgyMzkwMV9WNA" alt="img"></p>
<p>现在这里购物车是写死的固定值，我们应该将其配置在配置文件中，方便后期修改。</p>
<p>但现在的问题是，即便写在配置文件中，修改了配置还是需要重新打包、重启服务才能生效。能不能不用重启，直接生效呢？</p>
<p>这就要用到Nacos的配置热更新能力了，分为两步：</p>
<ul>
<li>在Nacos中添加配置</li>
<li>在微服务读取配置</li>
</ul>
<h3 id="添加配置到Nacos"><a href="#添加配置到Nacos" class="headerlink" title="添加配置到Nacos"></a>添加配置到Nacos</h3><p>首先，我们在nacos中添加一个配置文件，将购物车的上限数量添加到配置中：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=YmE2Mzg0YzljYzdhMGFhZjA5MzZlNGZmZmVkYWZkM2ZfR1dBdWx2ZUdwSEtsWURtVmViVnpCOTN3QWkycXVyUzJfVG9rZW46TnZicmJxSU1Yb1NPdDV4NGNxd2M0a21tbnJnXzE3MTQ4MjAzMjA6MTcxNDgyMzkyMF9WNA" alt="img"></p>
<p>注意文件的dataId格式：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">[服务名]-[spring.active.profile].[后缀名]</span><br></pre></td></tr></tbody></table></figure>

<p>不写spring acvite profile的话默认所有环境都共享</p>
<p>文件名称由三部分组成：</p>
<ul>
<li>**<code>服务名</code>**：我们是购物车服务，所以是<code>cart-service</code></li>
<li>**<code>spring.active.profile</code>**：就是spring boot中的<code>spring.active.profile</code>，可以省略，则所有profile共享该配置</li>
<li>**<code>后缀名</code>**：例如yaml</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "hm.cart")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartProperties</span> {</span><br><span class="line">    <span class="keyword">private</span> Integer maxItems;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>然后就可以写一个类动态读取数据了</p>
<h2 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h2><p>网关的路由配置全部是在项目启动时由<code>org.springframework.cloud.gateway.route.CompositeRouteDefinitionLocator</code>在项目启动的时候加载，并且一经加载就会缓存到内存中的路由表内（一个Map），不会改变。也不会监听路由变更，所以，我们无法利用上节课学习的配置热更新来实现路由更新。</p>
<p>因此，我们必须监听Nacos的配置变更，然后手动把最新的路由更新到路由表中。这里有两个难点：</p>
<ul>
<li>如何监听Nacos配置变更？</li>
<li>如何把路由信息更新到路由表？</li>
</ul>
<p>在Nacos官网中给出了手动监听Nacos配置变更的SDK：</p>
<p><a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/sdk.html">https://nacos.io/zh-cn/docs/sdk.html</a></p>
<p>如果希望 Nacos 推送配置变更，可以使用 Nacos 动态监听配置接口来实现。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(String dataId, String group, Listener listener)</span></span><br></pre></td></tr></tbody></table></figure>

<p>示例代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">serverAddr</span> <span class="operator">=</span> <span class="string">"{serverAddr}"</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> <span class="string">"{dataId}"</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> <span class="string">"{group}"</span>;</span><br><span class="line"><span class="comment">// 1.创建ConfigService，连接Nacos</span></span><br><span class="line"><span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">properties.put(<span class="string">"serverAddr"</span>, serverAddr);</span><br><span class="line"><span class="type">ConfigService</span> <span class="variable">configService</span> <span class="operator">=</span> NacosFactory.createConfigService(properties);</span><br><span class="line"><span class="comment">// 2.读取配置</span></span><br><span class="line"><span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> configService.getConfig(dataId, group, <span class="number">5000</span>);</span><br><span class="line"><span class="comment">// 3.添加配置监听器</span></span><br><span class="line">configService.addListener(dataId, group, <span class="keyword">new</span> <span class="title class_">Listener</span>() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveConfigInfo</span><span class="params">(String configInfo)</span> {</span><br><span class="line">        <span class="comment">// 配置变更的通知处理</span></span><br><span class="line">                System.out.println(<span class="string">"recieve1:"</span> + configInfo);</span><br><span class="line">        }</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Executor <span class="title function_">getExecutor</span><span class="params">()</span> {</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>



<h3 id="更新路由"><a href="#更新路由" class="headerlink" title="更新路由"></a>更新路由</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.cloud.gateway.route;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RouteDefinitionWriter</span> {</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新路由到路由表，如果路由id重复，则会覆盖旧的路由</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        Mono&lt;Void&gt; <span class="title function_">save</span><span class="params">(Mono&lt;RouteDefinition&gt; route)</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据路由id删除某个路由</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        Mono&lt;Void&gt; <span class="title function_">delete</span><span class="params">(Mono&lt;String&gt; routeId)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里更新的路由，也就是RouteDefinition，之前我们见过，包含下列常见字段：</p>
<ul>
<li>id：路由id</li>
<li>predicates：路由匹配规则</li>
<li>filters：路由过滤器</li>
<li>uri：路由目的地</li>
</ul>
<p>将来我们保存到Nacos的配置也要符合这个对象结构，将来我们以JSON来保存，格式如下：</p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"id"</span><span class="punctuation">:</span> <span class="string">"item"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"predicates"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Path"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="attr">"_genkey_0"</span><span class="punctuation">:</span><span class="string">"/items/**"</span><span class="punctuation">,</span> <span class="attr">"_genkey_1"</span><span class="punctuation">:</span><span class="string">"/search/**"</span><span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"filters"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"uri"</span><span class="punctuation">:</span> <span class="string">"lb://item-service"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>以上JSON配置就等同于：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">item</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://item-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/items/**,/search/**</span></span><br></pre></td></tr></tbody></table></figure>



<h4 id="实现动态路由"><a href="#实现动态路由" class="headerlink" title="实现动态路由"></a>实现动态路由</h4><p>首先， 我们在网关gateway引入依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--统一配置管理--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--加载bootstrap--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicRoute</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RouteDefinitionWriter routeDefinitionWriter;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> NacosConfigManager nacosConfigManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//路由配置文件的id和分组</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> <span class="string">"gateway-routes.json"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span>  <span class="string">"DEFAULT_GROUP"</span>;</span><br><span class="line">    <span class="comment">//保存更新后的路由id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; routeIds=<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initRouteConfigListener</span><span class="params">()</span> <span class="keyword">throws</span> NacosException {</span><br><span class="line">        <span class="comment">//1.注册并首次拉取配置</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">configInfo</span> <span class="operator">=</span> nacosConfigManager.getConfigService()</span><br><span class="line">                .getConfigAndSignListener(dataId, group, <span class="number">5000</span>, <span class="keyword">new</span> <span class="title class_">Listener</span>() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Executor <span class="title function_">getExecutor</span><span class="params">()</span> {</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveConfigInfo</span><span class="params">(String configInfo)</span> {</span><br><span class="line">                        updateRouteConfig(configInfo);</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">        <span class="comment">//2.首次启动时加载配置</span></span><br><span class="line">        updateRouteConfig(configInfo);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateRouteConfig</span><span class="params">(String configInfo)</span>{</span><br><span class="line">        log.debug(<span class="string">"监听到路由配置变更: {}"</span>,configInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.反序列化</span></span><br><span class="line">        List&lt;RouteDefinition&gt; routeDefinitionList = JSONUtil.toList(configInfo, RouteDefinition.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.更新前先删除旧的路由表</span></span><br><span class="line">        <span class="keyword">for</span> (String routeId : routeIds) {</span><br><span class="line">            <span class="comment">//记得写上订阅</span></span><br><span class="line">            routeDefinitionWriter.delete(Mono.just(routeId)).subscribe();</span><br><span class="line">        }</span><br><span class="line">        routeIds.clear();</span><br><span class="line">        <span class="comment">//更新路由表</span></span><br><span class="line">       <span class="comment">//没有变动直接跳过</span></span><br><span class="line">        <span class="keyword">if</span>(CollUtil.isEmpty(routeDefinitionList)){</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        routeDefinitionList.forEach(routeDefinition -&gt; {</span><br><span class="line">            <span class="comment">//更新路由</span></span><br><span class="line">            routeDefinitionWriter.save(Mono.just(routeDefinition)).subscribe();</span><br><span class="line">            <span class="comment">//记录路由id，方便后续更新时删除</span></span><br><span class="line">            routeIds.add(routeDefinition.getId());</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>





<p>我们直接在Nacos控制台添加路由，路由文件名为<code>gateway-routes.json</code>，类型为<code>json</code>：</p>
<p><img src="https://b11et3un53m.feishu.cn/space/api/box/stream/download/asynccode/?code=NmFlODRlZTQ4ODViZGQxZWNjNGZmNzMwNjA2NWM3NTZfbmF4TVNRNmJzVDlNRVdhUEdJa0IzV2FaNzRJYmF1TXlfVG9rZW46R0ZGTWJyS0Yxb3UyTHB4c2dPeGNUYmZPbmJkXzE3MTQ4MjMxMDU6MTcxNDgyNjcwNV9WNA" alt="img"></p>
<p>配置内容如下：</p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"id"</span><span class="punctuation">:</span> <span class="string">"item"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"predicates"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Path"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="attr">"_genkey_0"</span><span class="punctuation">:</span><span class="string">"/items/**"</span><span class="punctuation">,</span> <span class="attr">"_genkey_1"</span><span class="punctuation">:</span><span class="string">"/search/**"</span><span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"filters"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"uri"</span><span class="punctuation">:</span> <span class="string">"lb://item-service"</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"id"</span><span class="punctuation">:</span> <span class="string">"cart"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"predicates"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Path"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="attr">"_genkey_0"</span><span class="punctuation">:</span><span class="string">"/carts/**"</span><span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"filters"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"uri"</span><span class="punctuation">:</span> <span class="string">"lb://cart-service"</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"id"</span><span class="punctuation">:</span> <span class="string">"user"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"predicates"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Path"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="attr">"_genkey_0"</span><span class="punctuation">:</span><span class="string">"/users/**"</span><span class="punctuation">,</span> <span class="attr">"_genkey_1"</span><span class="punctuation">:</span><span class="string">"/addresses/**"</span><span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"filters"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"uri"</span><span class="punctuation">:</span> <span class="string">"lb://user-service"</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"id"</span><span class="punctuation">:</span> <span class="string">"order"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"predicates"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Path"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="attr">"_genkey_0"</span><span class="punctuation">:</span><span class="string">"/orders/**"</span><span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"filters"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"uri"</span><span class="punctuation">:</span> <span class="string">"lb://order-service"</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"id"</span><span class="punctuation">:</span> <span class="string">"pay"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"predicates"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Path"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="attr">"_genkey_0"</span><span class="punctuation">:</span><span class="string">"/pay-orders/**"</span><span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"filters"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"uri"</span><span class="punctuation">:</span> <span class="string">"lb://pay-service"</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></tbody></table></figure>







<h2 id="事务管理"><a href="#事务管理" class="headerlink" title="事务管理"></a>事务管理</h2><p>(sentinel,seata)感觉用组件一点感觉都没有…</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">末影</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/03/22/Java%E5%9F%BA%E7%A1%80/SpringCloud/">http://example.com/2024/03/22/Java%E5%9F%BA%E7%A1%80/SpringCloud/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">一只末影酱的小屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%96%B0%E4%B8%9C%E8%A5%BF/">新东西</a><a class="post-meta__tags" href="/tags/web/">web</a></div><div class="post_share"><div class="social-share" data-image="https://www.helloimg.com/i/2024/11/19/673c8661d457e.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/03/19/%E5%89%8D%E7%AB%AF/Vue%E5%AD%A6%E4%B9%A0/" title="Vue的学习之路"><img class="cover" src="https://www.helloimg.com/i/2024/11/19/673c865ff1191.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Vue的学习之路</div></div></a></div><div class="next-post pull-right"><a href="/2024/03/22/Java%E5%9F%BA%E7%A1%80/Java8/" title="java8基础知识"><img class="cover" src="https://www.helloimg.com/i/2024/11/19/673c8660d008c.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">java8基础知识</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/04/20/Docker%E5%AD%A6%E4%B9%A0/" title="Docker学习"><img class="cover" src="https://www.helloimg.com/i/2024/11/19/673c8661b723a.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-20</div><div class="title">Docker学习</div></div></a></div><div><a href="/2024/03/27/Linux/" title="Liunx踩坑之旅"><img class="cover" src="https://www.helloimg.com/i/2024/11/19/673c865f9cee7.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-27</div><div class="title">Liunx踩坑之旅</div></div></a></div><div><a href="/2024/03/22/Java%E5%9F%BA%E7%A1%80/Java8/" title="java8基础知识"><img class="cover" src="https://www.helloimg.com/i/2024/11/19/673c8660d008c.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-22</div><div class="title">java8基础知识</div></div></a></div><div><a href="/2024/05/05/Java%E5%9F%BA%E7%A1%80/rabbitmq/" title="rabbitmq"><img class="cover" src="https://img2.imgtp.com/2024/03/19/pHarN0Mf.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-05</div><div class="title">rabbitmq</div></div></a></div><div><a href="/2024/03/19/%E5%89%8D%E7%AB%AF/Vue%E5%AD%A6%E4%B9%A0/" title="Vue的学习之路"><img class="cover" src="https://www.helloimg.com/i/2024/11/19/673c865ff1191.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-19</div><div class="title">Vue的学习之路</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">末影</div><div class="author-info__description">只因不是出自真心，话语各位动听</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/moying688"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://blog.csdn.net/m0_74345527" target="_blank" title="CSDN"><i class="fa fa-book-open"></i></a><a class="social-icon" href="mailto:2869289913@qq.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">微服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud"><span class="toc-number">2.</span> <span class="toc-text">SpringCloud</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%BD%93%E9%A1%B9%E7%9B%AE%E6%8B%86%E5%88%86%E4%B8%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.1.</span> <span class="toc-text">单体项目拆分为微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E6%8B%86"><span class="toc-number">2.1.1.</span> <span class="toc-text">怎么拆</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">服务调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RestTemplate"><span class="toc-number">2.2.1.</span> <span class="toc-text">RestTemplate</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">2.3.</span> <span class="toc-text">服务注册</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">2.3.1.</span> <span class="toc-text">注册中心原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos"><span class="toc-number">2.4.</span> <span class="toc-text">Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">2.4.1.</span> <span class="toc-text">服务发现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenFeign"><span class="toc-number">2.5.</span> <span class="toc-text">OpenFeign</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenFeign%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">2.5.1.</span> <span class="toc-text">OpenFeign客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0-%E4%BA%86%E8%A7%A3"><span class="toc-number">2.5.2.</span> <span class="toc-text">连接池(了解?)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%BD%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">2.6.</span> <span class="toc-text">抽取客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%85%B3"><span class="toc-number">3.</span> <span class="toc-text">网关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%86%E7%BD%91%E5%85%B3"><span class="toc-number">3.1.</span> <span class="toc-text">认识网关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%B7%AF%E7%94%B1"><span class="toc-number">3.2.</span> <span class="toc-text">配置路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%BF%87%E6%BB%A4"><span class="toc-number">3.3.</span> <span class="toc-text">路由过滤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C"><span class="toc-number">4.</span> <span class="toc-text">网关登录校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%89%B4%E6%9D%83%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">鉴权思路分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">5.0.1.</span> <span class="toc-text">网关过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">5.0.1.1.</span> <span class="toc-text">自定义过滤器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89GlobalFilter"><span class="toc-number">5.1.</span> <span class="toc-text">自定义GlobalFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C"><span class="toc-number">5.2.</span> <span class="toc-text">登录校验</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">6.</span> <span class="toc-text">微服务获取用户信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Openfegin%E4%BC%A0%E9%80%92%E7%94%A8%E6%88%B7"><span class="toc-number">6.1.</span> <span class="toc-text">Openfegin传递用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">7.</span> <span class="toc-text">配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%85%B1%E4%BA%AB"><span class="toc-number">7.1.</span> <span class="toc-text">配置共享</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%85%B1%E4%BA%AB%E9%85%8D%E7%BD%AE"><span class="toc-number">7.2.</span> <span class="toc-text">添加共享配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E5%85%B1%E4%BA%AB%E9%85%8D%E7%BD%AE"><span class="toc-number">7.3.</span> <span class="toc-text">拉取共享配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-number">7.4.</span> <span class="toc-text">配置热更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E5%88%B0Nacos"><span class="toc-number">7.5.</span> <span class="toc-text">添加配置到Nacos</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">8.</span> <span class="toc-text">动态路由</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E8%B7%AF%E7%94%B1"><span class="toc-number">8.1.</span> <span class="toc-text">更新路由</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">8.1.1.</span> <span class="toc-text">实现动态路由</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text">事务管理</span></a></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/11/19/TestDemo/" title="TestDemo"><img src="https://www.helloimg.com/i/2024/11/19/673c865f9cee7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TestDemo"></a><div class="content"><a class="title" href="/2024/11/19/TestDemo/" title="TestDemo">TestDemo</a><time datetime="2024-11-19T12:58:34.000Z" title="发表于 2024-11-19 20:58:34">2024-11-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/15/JAVA%20BIO/" title="无题"><img src="https://www.helloimg.com/i/2024/11/19/673c8661b723a.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"></a><div class="content"><a class="title" href="/2024/11/15/JAVA%20BIO/" title="无题">无题</a><time datetime="2024-11-15T08:25:06.535Z" title="发表于 2024-11-15 16:25:06">2024-11-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/12/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="无题"><img src="https://www.helloimg.com/i/2024/11/19/673c8661b723a.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"></a><div class="content"><a class="title" href="/2024/11/12/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="无题">无题</a><time datetime="2024-11-12T14:48:54.127Z" title="发表于 2024-11-12 22:48:54">2024-11-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/15/%E9%9D%A2%E8%AF%95%E7%9B%B8%E5%85%B3/JVAV/" title="无题"><img src="https://www.helloimg.com/i/2024/11/19/673c865ec08b3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"></a><div class="content"><a class="title" href="/2024/10/15/%E9%9D%A2%E8%AF%95%E7%9B%B8%E5%85%B3/JVAV/" title="无题">无题</a><time datetime="2024-10-15T02:24:25.613Z" title="发表于 2024-10-15 10:24:25">2024-10-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/15/%E9%9D%A2%E8%AF%95%E7%9B%B8%E5%85%B3/os/" title="无题"><img src="https://www.helloimg.com/i/2024/11/19/673c86614db4d.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"></a><div class="content"><a class="title" href="/2024/10/15/%E9%9D%A2%E8%AF%95%E7%9B%B8%E5%85%B3/os/" title="无题">无题</a><time datetime="2024-10-15T02:24:15.329Z" title="发表于 2024-10-15 10:24:15">2024-10-15</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2020 - 2024 By 末影</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>